name: Docker Purge
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # every day at midnight
permissions: read-all

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

        ### https://github.com/snok/container-retention-policy?tab=readme-ov-file#safely-handling-multi-platform-multi-arch-packages
      - name: Fetch multi-platform package version SHAs
        id: multi-arch-digests
        run: |
          package1=$(docker manifest inspect ghcr.io/datawhores/of-scraper | jq -r '.manifests.[] | .digest' | paste -s -d ' ' -)
          echo "multi-arch-digests=$package1" >> $GITHUB_OUTPUT

      - name: Main purger
        uses: snok/container-retention-policy@v3.0.0
        with:
          account: datawhores
          image-names: of-scraper
          timestamp-to-use: created_at
          token: ${{ secrets.DOCKER_DELETE}}
          image-tags: sha*
          cut-off: 1 second ago UTC
          skip-shas: ${{ steps.multi-arch-digests.outputs.multi-arch-digests }}
      - name: Delete untagged
        uses: snok/container-retention-policy@v3.0.0
        with:
          account: datawhores
          image-names: of-scraper
          cut-off: 1 second ago UTC
          token: ${{ secrets.DOCKER_DELETE}}
          tag-selection: untagged
